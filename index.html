<!DOCTYPE html>
<html>
<head>
  <title>LearnWorlds User Manager</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { padding: 5px 10px; margin: 5px 0; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    button { cursor: pointer; }
    .enroll-btn { background-color: #4CAF50; color: white; }
    .unenroll-btn { background-color: #f44336; color: white; }
    .loading { color: #666; font-style: italic; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>LearnWorlds User Manager</h2>

  <label>User Email:</label>
  <input type="text" id="email" placeholder="Enter email">
  <button onclick="getUser()">Get User</button>

  <div id="userInfo"></div>
  <div id="courses"></div>
  <div id="products"></div>

  <script>
    const API_BASE = "https://securitymasterclasses.securityexcellence.net/admin/api/v2";
    const LW_CLIENT = "64facb2d6072346ff30ed226";
    const AUTH_TOKEN = "O4EwphUJmAjwegMMAxMYGZBpeewtpxF2PXrAv8yX";

    async function apiRequest(endpoint, method="GET", body=null) {
      const options = {
        method,
        headers: {
          "Accept": "application/json",
          "Authorization": `Bearer ${AUTH_TOKEN}`,
          "Lw-Client": LW_CLIENT,
          "Content-Type": "application/json"
        }
      };
      if (body) options.body = JSON.stringify(body);

      try {
        const res = await fetch(`${API_BASE}${endpoint}`, options);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        return await res.json();
      } catch (error) {
        console.error('API Request failed:', error);
        throw error;
      }
    }

    async function getUser() {
      const email = document.getElementById("email").value;
      if (!email) return alert("Please enter an email");

      try {
        // Show loading states
        document.getElementById("userInfo").innerHTML = '<div class="loading">Loading user info...</div>';
        document.getElementById("courses").innerHTML = '<div class="loading">Loading courses...</div>';
        document.getElementById("products").innerHTML = '<div class="loading">Loading products...</div>';

        // Get user info
        const user = await apiRequest(`/users/${encodeURIComponent(email)}?include_suspended=true`);
        // document.getElementById("userInfo").innerHTML = `<h3>User Info:</h3><pre>${JSON.stringify(user, null, 2)}</pre>`;

        // Get assigned courses
        const courses = await apiRequest(`/users/${encodeURIComponent(email)}/courses`);
        // displayCourses(courses, email);

        // Get user products
        const products = await apiRequest(`/users/${encodeURIComponent(email)}/products`);
        displayProducts(products, email);

      } catch (error) {
        document.getElementById("userInfo").innerHTML = `<div class="error">Error loading user: ${error.message}</div>`;
        document.getElementById("courses").innerHTML = '';
        document.getElementById("products").innerHTML = '';
      }
    }

    function displayCourses(coursesData, email) {
      console.log('Courses data received:', coursesData);
      
      // Handle LearnWorlds API response format
      let courses = [];
      if (coursesData && coursesData.data && Array.isArray(coursesData.data)) {
        // Extract course objects from the nested structure
        courses = coursesData.data.map(item => {
          if (item.course) {
            // Add enrollment info to course object
            return {
              ...item.course,
              enrollmentCreated: item.created,
              enrollmentExpires: item.expires
            };
          }
          return item;
        }).filter(course => course && course.id);
      } else if (Array.isArray(coursesData)) {
        courses = coursesData;
      }

      if (!courses || courses.length === 0) {
        document.getElementById("courses").innerHTML = `
          <h3>Assigned Courses:</h3>
          <p>No courses found.</p>
          <details>
            <summary>Debug Info</summary>
            <pre>${JSON.stringify(coursesData, null, 2)}</pre>
          </details>
        `;
        return;
      }

      const totalCourses = coursesData.meta ? coursesData.meta.totalItems : courses.length;
      let courseHtml = `<h3>Assigned Courses (${totalCourses}):</h3>
        <table>
          <tr>
            <th>Course Name</th>
            <th>Course ID</th>
            <th>Price</th>
            <th>Enrolled Date</th>
            <th>Action</th>
          </tr>`;
      
      courses.forEach(course => {
        const enrolledDate = course.enrollmentCreated 
          ? new Date(course.enrollmentCreated * 1000).toLocaleDateString()
          : 'N/A';
        
        courseHtml += `<tr>
          <td>${course.title || course.name || 'N/A'}</td>
          <td>${course.id || 'N/A'}</td>
          <td>${course.final_price || course.original_price || 'N/A'}</td>
          <td>${enrolledDate}</td>
          <td>
            <button class="unenroll-btn" onclick="unenrollCourse('${email}','${course.id}','course')">Unenroll</button>
          </td>
        </tr>`;
      });
      courseHtml += `</table>`;
      document.getElementById("courses").innerHTML = courseHtml;
    }

    function displayProducts(productsData, email) {
      console.log('Products data received:', productsData);
      
      // Handle different response formats
      let products = [];
      if (Array.isArray(productsData)) {
        products = productsData;
      } else if (productsData && productsData.data && Array.isArray(productsData.data)) {
        products = productsData.data;
      } else if (productsData && productsData.products && Array.isArray(productsData.products)) {
        products = productsData.products;
      } else if (productsData && typeof productsData === 'object') {
        // If it's an object, try to extract product information
        products = Object.values(productsData).filter(item => 
          item && typeof item === 'object' && (item.name || item.id)
        );
      }

      if (!products || products.length === 0) {
        document.getElementById("products").innerHTML = `
          <h3>Available Products:</h3>
          <p>No products found.</p>
          <details>
            <summary>Debug Info</summary>
            <pre>${JSON.stringify(productsData, null, 2)}</pre>
          </details>
        `;
        return;
      }

      let productHtml = `<h3>Products (${products.length}):</h3><table><tr><th>Product Name</th><th>Product ID</th><th>Type</th><th>Status</th><th>Action</th></tr>`;
      products.forEach(product => {
        // Check if user is enrolled (this depends on your API response structure)
        // You may need to adjust this logic based on how your API indicates enrollment
        const isEnrolled = product.enrolled !== false; // Assuming enrolled field exists
        const statusText = isEnrolled ? 'Enrolled' : 'Not Enrolled';
        const btnText = isEnrolled ? 'Unenroll' : 'Enroll';
        const btnClass = isEnrolled ? 'unenroll-btn' : 'enroll-btn';
        
        const action = isEnrolled 
          ? `unenrollCourse('${email}','${product.id}','${product.type}')` 
          : `enrollCourse('${email}','${product.id}','${product.type}')`;

        productHtml += `<tr>
          <td>${product.name || product.title || 'N/A'}</td>
          <td>${product.id || product.productId || 'N/A'}</td>
          <td>${product.type || product.productType || 'N/A'}</td>
          <td>${statusText}</td>
          <td><button class="${btnClass}" onclick="${action}">${btnText}</button></td>
        </tr>`;
      });
      productHtml += `</table>`;
      document.getElementById("products").innerHTML = productHtml;
    }

    async function unenrollCourse(email, productId, productType) {
      if (!confirm(`Are you sure you want to unenroll from ${productType}: ${productId}?`)) return;
      
      try {
        await apiRequest(`/users/${encodeURIComponent(email)}/enrollment`, "DELETE", {
          productId: productId,
          productType: productType
        });
        alert("Unenrolled successfully!");
        getUser(); // Refresh the data
      } catch (error) {
        alert(`Error unenrolling: ${error.message}`);
      }
    }

    async function enrollCourse(email, productId, productType, price = 0) {
      if (!confirm(`Are you sure you want to enroll in ${productType}: ${productId}?`)) return;
      
      try {
        await apiRequest(`/users/${encodeURIComponent(email)}/enrollment`, "POST", {
          productId: productId,
          productType: productType,
          justification: "Added by admin",
          price: price,
          send_enrollment_email: true
        });
        alert("Enrolled successfully!");
        getUser(); // Refresh the data
      } catch (error) {
        alert(`Error enrolling: ${error.message}`);
      }
    }
  </script>
</body>
</html>